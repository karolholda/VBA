Private Function RefreshAllData() As Boolean
    On Error GoTo ErrHandler

    Dim t0 As Double
    t0 = Timer   ' 1) zapamiętaj czas startu (do pomiaru długości refreshu)

    LogInfo "RefreshAllData", "Refresh started", ""

    ' 2) Odśwież wszystkie źródła danych w skoroszycie
    '    (Power Query, Connections, PivotCaches itp.)
    ThisWorkbook.RefreshAll

    ' 3) Poczekaj, aż zakończą się zapytania asynchroniczne
    '    (kluczowe dla Power Query)
    Application.CalculateUntilAsyncQueriesDone

    ' 4) Log zakończenia z czasem trwania
    LogInfo "RefreshAllData", "Refresh completed", _
            "DurationSec=" & Format(Timer - t0, "0.0")

    ' 5) Jeśli dotarliśmy tutaj – wszystko się udało
    RefreshAllData = True
    Exit Function

ErrHandler:
    ' 6) Obsługa błędu refreshu
    LogError "RefreshAllData", "Refresh failed", _
             "Err " & Err.Number & ": " & Err.Description

    RefreshAllData = False
End Function
